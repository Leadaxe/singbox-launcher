# Краткое руководство по ручному тестированию

## Что было изменено

### 1. generator.go
- ✅ Упрощена логика обработки секций
- ✅ Для секций `log`, `dns`, `inbounds`, `experimental` - возвращается текст как есть (сохраняются комментарии)
- ✅ Для секции `route` - используется `MergeRouteSectionText` (текстовый подход)

### 2. saver.go
- ✅ Текстовый подход для замены secret (regex вместо `json.MarshalIndent`)
- ✅ Сохраняются все комментарии при замене secret

### 3. loader.go (template)
- ✅ Текстовое извлечение секций с сохранением комментариев
- ✅ @SelectableRule блоки остаются в тексте (не удаляются)

### 4. route_text_merger.go
- ✅ Текстовое слияние route секции
- ✅ Обработка @SelectableRule блоков через текстовые замены
- ✅ Добавление пользовательских правил
- ✅ Обновление final outbound

### 5. selectable_rule_processor.go
- ✅ Обработка @SelectableRule блоков
- ✅ Удаление/обновление JSON правил после блоков

## Ключевые моменты для проверки

### ✅ Обязательно проверить

1. **Комментарии сохраняются в секциях**
   - Откройте исходный шаблон (`bin/config_template.json`)
   - Создайте конфиг через Wizard
   - Сравните комментарии в секциях `log`, `dns`, `inbounds`, `experimental`
   - Все комментарии должны быть на месте

2. **@SelectableRule блоки сохраняются**
   - Создайте конфиг с правилами в Wizard
   - Проверьте, что блоки `@SelectableRule` присутствуют в финальном конфиге
   - Проверьте, что метаданные (@label, @description) сохранились

3. **Валидность JSONC**
   - Финальный конфиг должен быть валидным JSONC
   - Sing-box должен корректно парсить конфиг

4. **Замена secret**
   - Создайте конфиг с `CHANGE_THIS_TO_YOUR_SECRET_TOKEN`
   - Сохраните конфиг
   - Проверьте, что secret заменен, но комментарии сохранились

### ⚠️ Потенциальные проблемы

1. **Trailing commas**
   - В `route_text_merger.go` много паттернов для удаления trailing commas
   - Проверьте, что trailing commas удаляются корректно
   - Проверьте различные варианты форматирования

2. **Пустые строки**
   - Проверьте, что пустые строки перед `]` удаляются корректно
   - Проверьте форматирование массива rules

3. **Вложенные структуры**
   - Проверьте, что комментарии в сложных вложенных структурах (например, `inbounds`) сохраняются

## Быстрая проверка

1. Откройте `bin/config_template.json`
2. Запомните несколько комментариев из разных секций
3. Создайте конфиг через Wizard
4. Откройте созданный конфиг
5. Проверьте, что все запомненные комментарии на месте

## Если что-то не работает

1. Проверьте логи (debuglog)
2. Проверьте валидность JSONC через `jsonc.Valid`
3. Попробуйте загрузить конфиг в sing-box
4. Сравните исходный шаблон и финальный конфиг построчно

## Следующие шаги после тестирования

1. Если все работает - можно оптимизировать код (убрать дублирующиеся паттерны в route_text_merger.go)
2. Если есть проблемы - записать их в issues
3. Обновить документацию, если нужно

